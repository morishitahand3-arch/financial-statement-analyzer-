# 決算書分析アプリ 機能拡張実装ドキュメント

## 📋 プロジェクト概要

企業の決算書（PDF形式）から財務データを自動抽出し、多角的な分析を行うWebアプリケーション。
日本企業の決算短信・有価証券報告書に対応し、財務指標の計算、成長性分析、業績予想比較などを提供します。

**実装日**: 2026年2月7日
**バージョン**: 2.0
**主要技術**: Python (Flask), JavaScript (Chart.js), pdfplumber, Claude API

---

## ✨ 実装済み機能

### 1. 基本財務分析（既存機能）

- **収益性分析**: ROE、ROA、売上高営業利益率
- **安全性分析**: 自己資本比率、流動比率、固定比率
- **財務諸表の可視化**: レーダーチャート

### 2. 成長性分析（新規実装）

- **前期比成長率の計算**: 売上高、営業利益、純利益の3指標
- **成長率の評価**:
  - 10%以上: 高成長
  - 5-10%: 順調な成長
  - 0-5%: 微増
  - マイナス: 減少（注意喚起）
- **総合評価コメントの自動生成**

**実装ファイル**: `backend/analyzers/growth.py`

### 3. 業績予想比較（新規実装）

- **達成率の計算**: 実績 ÷ 予想 × 100
- **評価基準**:
  - 90%以上: 優良（緑）
  - 80-90%: 標準（黄）
  - 80%未満: 要改善（赤）
- **売上高、営業利益、純利益の3指標を比較**

**実装ファイル**: `backend/analyzers/forecast_comparison.py`

### 4. KPI表示（新規実装）

- **主要業績指標を一目で確認**:
  - 売上高（当期・前期・成長率）
  - 営業利益（当期・前期・成長率）
  - 当期純利益（当期・前期・成長率）
- **グラデーションカードデザイン**で視認性向上
- **成長率の色分け表示**（緑: 正、赤: 負）

### 5. 経営陣コメント要約（新規実装）

- **Claude API（Haiku）による自動要約**:
  - 経営成績のポイント（3-5個の箇条書き）
  - 今後の見通しのポイント（3-5個の箇条書き）
- **APIキー未設定時の自動フォールバック**

**実装ファイル**: `backend/services/comment_summarizer.py`

### 6. 財務諸表の可視化強化（新規実装）

- **タブ切り替えUI**で複数のチャートを表示:
  - 総合: 財務指標レーダーチャート
  - 貸借対照表: 資産構成円グラフ
  - 損益計算書: 利益の流れ棒グラフ
  - キャッシュフロー: 3つのCF比較棒グラフ（実装予定）
- **Chart.js**による動的グラフ生成

**実装ファイル**: `frontend/static/js/financial_charts.js`

### 7. PDF解析の強化（新規実装）

- **pdfplumberによる表構造抽出**:
  - PyPDF2のテキスト抽出の限界を克服
  - セル単位での正確なデータ取得
- **複数期データの同時抽出**:
  - 日本の決算短信フォーマットに最適化
  - 1つのセルに複数期データが改行区切りで含まれるパターンに対応
- **抽出項目**:
  - 前期損益計算書（売上高、営業利益、純利益）
  - 業績予想（通期予想の売上高、営業利益、純利益）
  - キャッシュフロー（営業CF、投資CF、財務CF）
  - セグメント情報（セグメント別売上高・営業利益）
  - 会社コメント（経営成績、今後の見通し）

**実装ファイル**: `backend/services/pdf_parser.py`

---

## 🗂️ データモデル

### 新規追加モデル

1. **PerformanceForecast** (`backend/models/forecast.py`)
   - 業績予想データを格納
   - フィールド: revenue_forecast, operating_income_forecast, net_income_forecast

2. **CashFlowStatement** (`backend/models/cash_flow.py`)
   - キャッシュフロー計算書を格納
   - フィールド: operating_cash_flow, investing_cash_flow, financing_cash_flow
   - 自動計算: free_cash_flow
   - メソッド: get_cash_flow_type()

3. **Segment / SegmentAnalysis** (`backend/models/segment.py`)
   - セグメント情報を格納
   - メソッド: calculate_margin(), get_segment_ratio(), get_largest_segment()

---

## 🏗️ アーキテクチャ

### バックエンド構成

```
backend/
├── models/                    # データモデル
│   ├── balance_sheet.py       # 貸借対照表
│   ├── income_statement.py    # 損益計算書
│   ├── forecast.py            # 業績予想（新規）
│   ├── cash_flow.py           # キャッシュフロー（新規）
│   └── segment.py             # セグメント（新規）
├── services/
│   ├── pdf_parser.py          # PDF解析（拡張）
│   ├── financial_analyzer.py  # 財務分析統合（拡張）
│   └── comment_summarizer.py  # コメント要約（新規）
├── analyzers/
│   ├── profitability.py       # 収益性分析
│   ├── safety.py              # 安全性分析
│   ├── growth.py              # 成長性分析（新規）
│   ├── forecast_comparison.py # 予想比較（新規）
│   └── segment_analyzer.py    # セグメント分析（新規）
└── app.py                     # Flaskアプリ（拡張）
```

### フロントエンド構成

```
frontend/
├── templates/
│   └── results.html           # 分析結果画面（大幅拡張）
├── static/
│   ├── css/
│   │   └── style.css          # スタイル（大幅拡張）
│   └── js/
│       ├── charts.js          # メイン表示ロジック（拡張）
│       └── financial_charts.js # チャート生成（新規）
```

---

## 📊 データフロー

```
1. PDFアップロード
   ↓
2. PDF解析（pdf_parser.py）
   - pdfplumberで表抽出
   - 当期・前期・予想データを同時抽出
   ↓
3. データモデル化
   - IncomeStatement（当期・前期）
   - PerformanceForecast
   - CashFlowStatement
   - SegmentAnalysis
   ↓
4. 各種分析実行（financial_analyzer.py）
   - 収益性分析
   - 安全性分析
   - 成長性分析（前期がある場合）
   - 予想比較分析（予想がある場合）
   - コメント要約（コメントがある場合）
   ↓
5. JSON形式でフロントエンドに返却
   ↓
6. JavaScript表示ロジック
   - displayKPIs()
   - displayGrowthAnalysis()
   - displayForecastComparison()
   - displayCompanyComments()
   - チャート生成
```

---

## 🔧 技術仕様

### PDF解析ロジック

#### 前期データ抽出

日本の決算短信では、1つのセルに複数期のデータが改行区切りで格納される：

```
セル例:
2026年3月期第3四半期
2025年3月期第3四半期

売上高セル例:
百万円
1,731,715
1,776,166
```

**抽出ロジック**:
1. ヘッダー行から各項目（売上高、営業利益、純利益）の列インデックスを特定
2. データ行から年度情報（`(\d{4})年.*?\n.*?(\d{4})年`パターン）を検索
3. 各列のセルから数値を抽出（改行区切り）
4. 最初の数値が当期、2番目が前期

**実装関数**: `_extract_previous_income_statement()`

#### 業績予想抽出

**抽出ロジック**:
1. ヘッダー行から「売上高」「営業利益」「純利益」列を特定
2. データ行から「通期」を含む行を検索
3. 各列から数値を抽出（1つのセルに1つの数値）
4. 注意: 「1株当たり純利益」列を除外

**実装関数**: `_extract_forecast_from_table()`

### 成長率計算

```python
成長率 = (当期 - 前期) ÷ 前期 × 100
```

**ゼロ除算対策**: 前期が0の場合はNoneを返す

### 達成率計算

```python
達成率 = 実績 ÷ 予想 × 100
```

**評価基準**:
- 90%以上: achievement-high (緑)
- 80-90%: achievement-medium (黄)
- 80%未満: achievement-low (赤)

---

## 💻 使用方法

### 1. 環境構築

```bash
# パッケージインストール
pip install -r requirements.txt

# 環境変数設定（Claude API使用時）
cp .env.example .env
# .envファイルを編集してANTHROPIC_API_KEYを設定
```

### 2. アプリ起動

```bash
cd backend
python app.py
```

ブラウザで http://localhost:5000 を開く

### 3. PDF分析

1. 「ファイルを選択」ボタンからPDFをアップロード
2. 自動的に分析が実行される
3. 分析結果ページで以下を確認:
   - 💰 KPI（売上高、営業利益、純利益）
   - 📈 成長性分析（前期データがある場合）
   - 🎯 業績予想比較（予想データがある場合）
   - 💬 経営陣コメント（Claude APIキー設定時）
   - 📊 財務諸表グラフ（タブ切り替え）

---

## 🎨 UI/UXの改善点

### KPIカード

- **グラデーション背景**: 視覚的インパクト
- **大きな数値表示**: 一目で分かる
- **成長率の色分け**:
  - 緑（↑）: プラス成長
  - 赤（↓）: マイナス成長

### 業績予想比較

- **達成率の色分け**:
  - 緑: 90%以上
  - 黄: 80-90%
  - 赤: 80%未満
- **実績・予想・達成率を並べて表示**

### タブUI

- **4つのタブ**: 総合、BS、PL、CF
- **スムーズなアニメーション**: fadeIn効果
- **アクティブタブの強調表示**

---

## 📦 依存パッケージ

### Python

```txt
Flask==3.0.0
Flask-CORS==4.0.0
pdfplumber==0.11.0         # 新規追加
PyPDF2==3.0.1
python-dotenv==1.0.0
pytest==7.4.3
python-dateutil==2.8.2
anthropic>=0.18.0          # 新規追加
```

### JavaScript

- Chart.js (CDN)

---

## 🐛 既知の問題と対応

### 1. 数値表示の問題（解決済み）

**問題**: KPIの数値が「2百万円」など極端に小さく表示される

**原因**: APIから返される値は既に百万円単位なのに、JavaScript側で再度1,000,000で割っていた

**解決策**: `formatCurrency()`関数を修正
```javascript
// 修正前
const millions = value / 1000000;

// 修正後
return `${value.toLocaleString('ja-JP', {maximumFractionDigits: 0})}百万円`;
```

### 2. PDF解析の精度

**課題**: 企業ごとにPDFフォーマットが異なる

**対応**:
- 複数のパターンマッチングを実装
- フォールバックロジックを用意
- ヘッダー行での列特定 + データ行での数値抽出

**改善余地**:
- より多くの決算書フォーマットでテスト
- 機械学習による表認識の導入検討

### 3. Claude API呼び出し

**エラーハンドリング**:
- APIキー未設定時: 要約をスキップし、エラーメッセージを表示
- API呼び出し失敗時: try-exceptでキャッチし、エラー内容を返す

---

## 🔮 今後の拡張予定

### Phase 4: セグメント分析

- [ ] セグメント別売上構成比の円グラフ
- [ ] セグメント別営業利益率の棒グラフ
- [ ] 主力セグメントの自動特定
- [ ] セグメント集中度の評価

### 追加機能案

- [ ] キャッシュフロー分析の充実
  - CFパターン判定（健全型、成長型、警告型）
  - フリーキャッシュフローの推移
- [ ] 複数期比較
  - 3期、5期の推移グラフ
  - トレンド分析
- [ ] 業界平均との比較
  - 業種データベースの構築
  - 相対評価の表示
- [ ] PDFレポート出力
  - 分析結果のPDF化
  - 印刷最適化
- [ ] データベース連携
  - 分析履歴の保存
  - 企業検索機能

---

## 📝 テスト結果

### テスト環境

- **サンプルPDF**: 東京エレクトロン株式会社 2026年3月期第3四半期決算短信
- **テスト日**: 2026年2月7日

### 抽出結果

| 項目 | 抽出値 | 備考 |
|------|--------|------|
| 売上高（当期） | 1,731,715百万円 | ✅ 正確 |
| 営業利益（当期） | 419,293百万円 | ✅ 正確 |
| 純利益（当期） | 360,164百万円 | ✅ 正確 |
| 売上高（前期） | 1,776,166百万円 | ✅ 正確 |
| 営業利益（前期） | 513,521百万円 | ✅ 正確 |
| 純利益（前期） | 401,167百万円 | ✅ 正確 |
| 売上高予想 | 2,410,000百万円 | ✅ 正確 |
| 営業利益予想 | 593,000百万円 | ✅ 正確 |
| 純利益予想 | 550,000百万円 | ✅ 正確 |

### 計算結果

| 指標 | 計算値 | 備考 |
|------|--------|------|
| 売上高成長率 | -2.5% | ✅ 正確 |
| 営業利益成長率 | -18.3% | ✅ 正確 |
| 純利益成長率 | -10.2% | ✅ 正確 |
| 売上高達成率 | 71.9% | ✅ 正確（第3四半期なので妥当） |
| 営業利益達成率 | 70.7% | ✅ 正確 |
| 純利益達成率 | 65.5% | ✅ 正確 |

---

## 🙏 謝辞

本プロジェクトは以下のオープンソースライブラリを使用しています：

- **Flask**: Webフレームワーク
- **pdfplumber**: PDF表抽出
- **Chart.js**: グラフ描画
- **Claude API**: AI要約

---

## 📄 ライセンス

このプロジェクトは個人学習目的で作成されています。

---

## 📞 サポート

問題が発生した場合:

1. ブラウザのキャッシュをクリア（Ctrl+Shift+R）
2. Flaskアプリを再起動
3. デバッグ用スクリプトでPDF解析結果を確認:
   ```bash
   python test_pdf_extraction.py
   ```

---

**最終更新**: 2026年2月7日
**作成者**: Claude Code with Human Collaboration
